<!DOCTYPE html>
<html>
<head>
    <title>Firebase Auth Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        button {
            padding: 8px 16px;
            background: #4285F4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px 0;
        }
        button:hover {
            background: #3367D6;
        }
        pre {
            background: #f4f4f4;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            white-space: pre-wrap;
            overflow-x: auto;
        }
        .hidden {
            display: none;
        }
        .section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        input {
            padding: 8px;
            width: 100%;
            margin-bottom: 10px;
        }
        .important {
            color: red;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Firebase Authentication Test</h1>
    
    <div class="section">
        <h2>1. Authentication</h2>
        <div id="auth-section">
            <p class="important">Important: Make sure "localhost" is added to the authorized domains in the Firebase console (Authentication → Settings → Authorized domains)</p>
            <p>Current status: <strong id="auth-status">Not authenticated</strong></p>
            <div id="not-logged-in">
                <button id="google-sign-in">Sign in with Google</button>
            </div>
            <div id="logged-in" class="hidden">
                <p>Logged in as: <span id="user-email"></span></p>
                <p>User ID: <span id="user-id"></span></p>
                <p>ID Token: <button id="show-token">Show/Hide Token</button></p>
                <pre id="token-display" class="hidden"></pre>
                <button id="sign-out">Sign Out</button>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>2. Test API Endpoints</h2>
        <div id="api-section" class="hidden">
            <p>Test your authenticated API endpoints:</p>
            
            <div>
                <input type="text" id="api-url" placeholder="Enter API URL to test">
                <button id="test-api">Test API with Token</button>
            </div>
            
            <h3>API Response:</h3>
            <pre id="api-response">No response yet</pre>
        </div>
    </div>

    <!-- Add Firebase libraries -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <script>
        // Replace with your Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyDoAzsda-TOwoqcAt7DAsL1GDsp_2NSi30",
            authDomain: "relexro.firebaseapp.com",
            projectId: "relexro",
            storageBucket: "relexro.appspot.com",
            messagingSenderId: "764589667187",
            appId: "1:49787884280:web:80501323bdb2f5fbcb610d"
        };
        
        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
            alert("Firebase initialization error: " + error.message);
        }
        
        // Elements
        const authStatus = document.getElementById('auth-status');
        const notLoggedIn = document.getElementById('not-logged-in');
        const loggedIn = document.getElementById('logged-in');
        const userEmail = document.getElementById('user-email');
        const userId = document.getElementById('user-id');
        const tokenDisplay = document.getElementById('token-display');
        const showTokenBtn = document.getElementById('show-token');
        const googleSignInBtn = document.getElementById('google-sign-in');
        const signOutBtn = document.getElementById('sign-out');
        const apiSection = document.getElementById('api-section');
        const apiUrlInput = document.getElementById('api-url');
        const testApiBtn = document.getElementById('test-api');
        const apiResponse = document.getElementById('api-response');
        
        // Current token
        let currentToken = null;
        
        // Auth state listener
        firebase.auth().onAuthStateChanged(function(user) {
            if (user) {
                // User is signed in
                authStatus.textContent = 'Authenticated';
                userEmail.textContent = user.email;
                userId.textContent = user.uid;
                
                // Get token
                user.getIdToken().then(function(token) {
                    currentToken = token;
                    tokenDisplay.textContent = token;
                });
                
                // Update UI
                notLoggedIn.classList.add('hidden');
                loggedIn.classList.remove('hidden');
                apiSection.classList.remove('hidden');
            } else {
                // User is signed out
                authStatus.textContent = 'Not authenticated';
                notLoggedIn.classList.remove('hidden');
                loggedIn.classList.add('hidden');
                apiSection.classList.add('hidden');
                
                // Clear data
                currentToken = null;
                tokenDisplay.textContent = '';
                userEmail.textContent = '';
                userId.textContent = '';
            }
        });
        
        // Show/hide token
        showTokenBtn.addEventListener('click', function() {
            if (tokenDisplay.classList.contains('hidden')) {
                tokenDisplay.classList.remove('hidden');
            } else {
                tokenDisplay.classList.add('hidden');
            }
        });
        
        // Google sign-in
        googleSignInBtn.addEventListener('click', function() {
            console.log("Attempting Google sign-in");
            const provider = new firebase.auth.GoogleAuthProvider();
            // Add scopes and custom parameters
            provider.addScope('profile');
            provider.addScope('email');
            provider.setCustomParameters({
                'prompt': 'select_account'
            });
            
            // Try redirect auth instead of popup if popup fails
            firebase.auth().signInWithPopup(provider).catch(function(error) {
                console.error('Sign in error with popup:', error);
                alert('Sign in with popup failed: ' + error.message + '. Trying redirect method...');
                
                // Try redirect method as fallback
                firebase.auth().signInWithRedirect(provider).catch(function(redirectError) {
                    console.error('Sign in error with redirect:', redirectError);
                    alert('Sign in failed with both methods: ' + redirectError.message);
                });
            });
        });
        
        // Check for redirect result on page load
        firebase.auth().getRedirectResult().then(function(result) {
            if (result.credential) {
                console.log("Redirect auth succeeded");
            }
        }).catch(function(error) {
            console.error("Redirect auth error:", error);
        });
        
        // Sign out
        signOutBtn.addEventListener('click', function() {
            firebase.auth().signOut().catch(function(error) {
                console.error('Sign out error:', error);
            });
        });
        
        // Test API
        testApiBtn.addEventListener('click', function() {
            if (!currentToken) {
                apiResponse.textContent = 'Error: Not authenticated';
                return;
            }
            
            const apiUrl = apiUrlInput.value.trim();
            if (!apiUrl) {
                apiResponse.textContent = 'Error: Please enter an API URL';
                return;
            }
            
            apiResponse.textContent = 'Loading...';
            
            fetch(apiUrl, {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + currentToken
                }
            })
            .then(response => {
                return response.text().then(text => {
                    try {
                        // Try to parse as JSON
                        return {
                            status: response.status,
                            ok: response.ok,
                            data: JSON.parse(text)
                        };
                    } catch (e) {
                        // Return as text if not JSON
                        return {
                            status: response.status,
                            ok: response.ok,
                            data: text
                        };
                    }
                });
            })
            .then(result => {
                apiResponse.textContent = 'Status: ' + result.status + '\n\n' + JSON.stringify(result.data, null, 2);
            })
            .catch(error => {
                apiResponse.textContent = 'Error: ' + error.message;
            });
        });
    </script>
</body>
</html> 